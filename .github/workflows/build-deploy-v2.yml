name: Cloud Panel Deployment Workflow V2

on:
  repository_dispatch:
    types: [provision-timora]
  workflow_dispatch:
    inputs:
      system:
        description: "System type"
        required: true
        type: string
      plan:
        description: "Plan type"
        required: true
        type: string
      email:
        description: "User email"
        required: true
        type: string
      company_name:
        description: "Company name"
        required: true
        type: string
      domain_name:
        description: "Domain name"
        required: true
        type: string
      company_code:
        description: "Company code"
        required: true
        type: string
      username:
        description: "User name"
        required: true
        type: string
      password:
        description: "User password"
        required: true
        type: string
      billing_cycle:
        description: "Billing cycle (monthly/yearly)"
        required: true
        type: string
      amount:
        description: "Amount paid"
        required: true
        type: string
      reference_number:
        description: "Payment reference number"
        required: false
        type: string
      callback_url:
        description: "Provisioning callback URL"
        required: false
        type: string

      subscription_details:
        description: "Wizard subscription details JSON"
        required: false
        type: string

      pricing_breakdown:
        description: "Wizard pricing breakdown JSON"
        required: false
        type: string

      selected_devices:
        description: "Selected devices JSON"
        required: false
        type: string

      selected_biometric_services:
        description: "Selected biometric services JSON"
        required: false
        type: string

      company_details:
        description: "Company details JSON"
        required: false
        type: string

      user_details:
        description: "User details JSON"
        required: false
        type: string

jobs:
  laravel-tests:
    name: Build Logs
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: laravel
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h localhost"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
      # ‚úÖ ADDED: Extract variables for repository_dispatch events
      - name: Extract variables from payload
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "COMPANY_CODE=${{ github.event.client_payload.company_code }}" >> $GITHUB_ENV
            echo "COMPANY_NAME=${{ github.event.client_payload.company_name }}" >> $GITHUB_ENV
            echo "DOMAIN_NAME=${{ github.event.client_payload.domain_name }}" >> $GITHUB_ENV
            echo "EMAIL=${{ github.event.client_payload.email }}" >> $GITHUB_ENV
            echo "USERNAME=${{ github.event.client_payload.username }}" >> $GITHUB_ENV
            echo "PASSWORD=${{ github.event.client_payload.password }}" >> $GITHUB_ENV
            echo "SYSTEM=${{ github.event.client_payload.system }}" >> $GITHUB_ENV
            echo "PLAN=${{ github.event.client_payload.plan }}" >> $GITHUB_ENV
            echo "BILLING_CYCLE=${{ github.event.client_payload.billing_cycle }}" >> $GITHUB_ENV
            echo "AMOUNT=${{ github.event.client_payload.amount }}" >> $GITHUB_ENV
            echo "CALLBACK_URL=${{ github.event.client_payload.callback_url }}" >> $GITHUB_ENV
            echo "REFERENCE_NUMBER=${{ github.event.client_payload.reference_number }}" >> $GITHUB_ENV
            echo "SUBSCRIPTION_DETAILS=${{ github.event.client_payload.subscription_details }}" >> $GITHUB_ENV
            echo "PRICING_BREAKDOWN=${{ github.event.client_payload.pricing_breakdown }}" >> $GITHUB_ENV
            echo "SELECTED_DEVICES=${{ github.event.client_payload.selected_devices }}" >> $GITHUB_ENV
            echo "SELECTED_BIOMETRIC_SERVICES=${{ github.event.client_payload.selected_biometric_services }}" >> $GITHUB_ENV
            echo "COMPANY_DETAILS=${{ github.event.client_payload.company_details }}" >> $GITHUB_ENV
            echo "USER_DETAILS=${{ github.event.client_payload.user_details }}" >> $GITHUB_ENV
          else
            echo "COMPANY_CODE=${{ github.event.inputs.company_code }}" >> $GITHUB_ENV
            echo "COMPANY_NAME=${{ github.event.inputs.company_name }}" >> $GITHUB_ENV
            echo "DOMAIN_NAME=${{ github.event.inputs.domain_name }}" >> $GITHUB_ENV
            echo "EMAIL=${{ github.event.inputs.email }}" >> $GITHUB_ENV
            echo "USERNAME=${{ github.event.inputs.username }}" >> $GITHUB_ENV
            echo "PASSWORD=${{ github.event.inputs.password }}" >> $GITHUB_ENV
            echo "SYSTEM=${{ github.event.inputs.system }}" >> $GITHUB_ENV
            echo "PLAN=${{ github.event.inputs.plan }}" >> $GITHUB_ENV
            echo "BILLING_CYCLE=${{ github.event.inputs.billing_cycle }}" >> $GITHUB_ENV
            echo "AMOUNT=${{ github.event.inputs.amount }}" >> $GITHUB_ENV
            echo "CALLBACK_URL=https://api-wizard.timora.ph/api/wizard/provisioning/github-callback" >> $GITHUB_ENV
          fi

      - name: Decode wizard password
        shell: bash
        run: |
          if [ -z "${PASSWORD}" ]; then
            echo "‚ùå PASSWORD is missing"
            exit 1
          fi

          # Decode Base64 password from wizard
          DECODED_PASSWORD="$(echo "${PASSWORD}" | base64 --decode)"

          if [ -z "$DECODED_PASSWORD" ]; then
            echo "‚ùå Password decoding failed"
            exit 1
          fi

          # Overwrite PASSWORD with decoded value
          echo "PASSWORD<<EOF" >> $GITHUB_ENV
          echo "$DECODED_PASSWORD" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      # ‚úÖ UPDATED: Use dynamic callback URL and progress percentage
      - name: üöÄ Notify Provisioning Started
        run: |
          curl -X POST "${{ env.CALLBACK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "company_code": "${{ env.COMPANY_CODE }}",
              "status": "started",
              "step": "initialization",
              "progress_percentage": 10,
              "message": "GitHub Actions workflow started - Setting up build environment",
              "logs": "Workflow triggered at $(date) with inputs: system=${{ env.SYSTEM }}, plan=${{ env.PLAN }}, domain=${{ env.DOMAIN_NAME }}"
            }' || echo "Callback failed - continuing..."

      - name: Checkout code
        uses: actions/checkout@v3

      # ‚úÖ UPDATED: Use dynamic variables and add progress percentage
      - name: üìã Notify Build Phase
        run: |
          curl -X POST "${{ env.CALLBACK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "company_code": "${{ env.COMPANY_CODE }}",
              "status": "started",
              "step": "build",
              "progress_percentage": 25,
              "message": "Setting up PHP environment and installing dependencies",
              "logs": "Starting PHP 8.2 setup and Composer installation at $(date)"
            }' || echo "Callback failed - continuing..."

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.2"
          extensions: mbstring, bcmath, mysql
          coverage: none

      - name: Install Composer dependencies
        run: |
          echo "Installing Composer dependencies..."
          composer install --prefer-dist --no-progress --no-suggest
          curl -X POST "${{ env.CALLBACK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "company_code": "${{ env.COMPANY_CODE }}",
              "status": "started",
              "step": "build",
              "progress_percentage": 30,
              "message": "Dependencies installed successfully",
              "logs": "Composer dependencies installed at $(date)"
            }' || echo "Callback failed - continuing..."

      - name: Set up environment
        env:
          HITPAY_API_KEY: ${{ secrets.HITPAY_API_KEY }}
          HITPAY_SALT: ${{ secrets.HITPAY_SALT }}
          HITPAY_BASE_URL: ${{ secrets.HITPAY_BASE_URL }}
          HITPAY_WEBHOOK_URL: ${{ secrets.HITPAY_WEBHOOK_URL }}
        run: |
          echo "${{ secrets.ENV }}" > .env
          php artisan key:generate
          curl -X POST "${{ env.CALLBACK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "company_code": "${{ env.COMPANY_CODE }}",
              "status": "started",
              "step": "build",
              "progress_percentage": 35,
              "message": "Environment configuration completed",
              "logs": "Laravel environment configured and app key generated at $(date)"
            }' || echo "Callback failed - continuing..."

      - name: Wait for MySQL to be ready
        run: sleep 15

      # ‚úÖ UPDATED: Use dynamic variables and add progress percentage
      - name: üóÑÔ∏è Notify Database Phase
        run: |
          curl -X POST "${{ env.CALLBACK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "company_code": "${{ env.COMPANY_CODE }}",
              "status": "started",
              "step": "database",
              "progress_percentage": 40,
              "message": "Running database migrations and tests",
              "logs": "Database setup started at $(date) - waiting for MySQL service"
            }' || echo "Callback failed - continuing..."

      - name: Run migrations
        env:
          DB_CONNECTION: mysql
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_DATABASE: laravel
          DB_USERNAME: root
          DB_PASSWORD: root
        run: |
          php artisan migrate --force
          curl -X POST "${{ env.CALLBACK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "company_code": "${{ env.COMPANY_CODE }}",
              "status": "started",
              "step": "database",
              "progress_percentage": 45,
              "message": "Database migrations completed successfully",
              "logs": "Laravel migrations executed successfully at $(date)"
            }' || echo "Callback failed - continuing..."

  deploy:
    name: Deployment Summary
    needs: laravel-tests
    runs-on: ubuntu-latest

    steps:
      # ‚úÖ ADDED: Extract variables for repository_dispatch events (duplicate from first job)
      - name: Extract variables from payload
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "COMPANY_CODE=${{ github.event.client_payload.company_code }}" >> $GITHUB_ENV
            echo "COMPANY_NAME=${{ github.event.client_payload.company_name }}" >> $GITHUB_ENV
            echo "DOMAIN_NAME=${{ github.event.client_payload.domain_name }}" >> $GITHUB_ENV
            echo "EMAIL=${{ github.event.client_payload.email }}" >> $GITHUB_ENV
            echo "USERNAME=${{ github.event.client_payload.username }}" >> $GITHUB_ENV
            echo "PASSWORD=${{ github.event.client_payload.password }}" >> $GITHUB_ENV
            echo "SYSTEM=${{ github.event.client_payload.system }}" >> $GITHUB_ENV
            echo "PLAN=${{ github.event.client_payload.plan }}" >> $GITHUB_ENV
            echo "BILLING_CYCLE=${{ github.event.client_payload.billing_cycle }}" >> $GITHUB_ENV
            echo "AMOUNT=${{ github.event.client_payload.amount }}" >> $GITHUB_ENV
            echo "CALLBACK_URL=${{ github.event.client_payload.callback_url }}" >> $GITHUB_ENV
            echo "REFERENCE_NUMBER=${{ github.event.client_payload.reference_number }}" >> $GITHUB_ENV
            echo "SUBSCRIPTION_DETAILS=${{ github.event.client_payload.subscription_details }}" >> $GITHUB_ENV
            echo "PRICING_BREAKDOWN=${{ github.event.client_payload.pricing_breakdown }}" >> $GITHUB_ENV
            echo "SELECTED_DEVICES=${{ github.event.client_payload.selected_devices }}" >> $GITHUB_ENV
            echo "SELECTED_BIOMETRIC_SERVICES=${{ github.event.client_payload.selected_biometric_services }}" >> $GITHUB_ENV
            echo "COMPANY_DETAILS=${{ github.event.client_payload.company_details }}" >> $GITHUB_ENV
            echo "USER_DETAILS=${{ github.event.client_payload.user_details }}" >> $GITHUB_ENV
          else
            echo "COMPANY_CODE=${{ github.event.inputs.company_code }}" >> $GITHUB_ENV
            echo "COMPANY_NAME=${{ github.event.inputs.company_name }}" >> $GITHUB_ENV
            echo "DOMAIN_NAME=${{ github.event.inputs.domain_name }}" >> $GITHUB_ENV
            echo "EMAIL=${{ github.event.inputs.email }}" >> $GITHUB_ENV
            echo "USERNAME=${{ github.event.inputs.username }}" >> $GITHUB_ENV
            echo "PASSWORD=${{ github.event.inputs.password }}" >> $GITHUB_ENV
            echo "SYSTEM=${{ github.event.inputs.system }}" >> $GITHUB_ENV
            echo "PLAN=${{ github.event.inputs.plan }}" >> $GITHUB_ENV
            echo "BILLING_CYCLE=${{ github.event.inputs.billing_cycle }}" >> $GITHUB_ENV
            echo "AMOUNT=${{ github.event.inputs.amount }}" >> $GITHUB_ENV
            echo "CALLBACK_URL=https://api-wizard.timora.ph/api/wizard/provisioning/github-callback" >> $GITHUB_ENV
          fi

      - name: Decode wizard password
        shell: bash
        run: |
          if [ -z "${PASSWORD}" ]; then
            echo "‚ùå PASSWORD is missing"
            exit 1
          fi

          # Decode Base64 password from wizard
          DECODED_PASSWORD="$(echo "${PASSWORD}" | base64 --decode)"

          if [ -z "$DECODED_PASSWORD" ]; then
            echo "‚ùå Password decoding failed"
            exit 1
          fi

          # Overwrite PASSWORD with decoded value
          echo "PASSWORD<<EOF" >> $GITHUB_ENV
          echo "$DECODED_PASSWORD" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Checkout code
        uses: actions/checkout@v3

      # ‚úÖ UPDATED: Use dynamic variables and add progress percentage
      - name: üåê Notify Infrastructure Phase
        run: |
          curl -X POST "${{ env.CALLBACK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "company_code": "${{ env.COMPANY_CODE }}",
              "status": "started",
              "step": "infrastructure",
              "progress_percentage": 55,
              "message": "Creating DNS records and server infrastructure",
              "logs": "Infrastructure setup started at $(date) - configuring DNS and networking"
            }' || echo "Callback failed - continuing..."

      - name: Create DNS record via Cloudflare API
        run: |
          SUBDOMAIN=$(echo "${{ env.DOMAIN_NAME }}" | tr '[:upper:]' '[:lower:]' | tr -d ' ')
          ROOT_DOMAIN=timora.ph
          FULL_DOMAIN="$SUBDOMAIN.$ROOT_DOMAIN"

          curl -X POST "https://api.cloudflare.com/client/v4/zones/${{ secrets.CLOUDFLARE_ZONE_ID }}/dns_records" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            --data '{
              "type": "A",
              "name": "'"$FULL_DOMAIN"'",
              "content": "'"${{ secrets.VPS_PUBLIC_IP }}"'",
              "ttl": 120,
              "proxied": true
            }'

          echo "‚úÖ DNS record created: $FULL_DOMAIN"
          echo "SUBDOMAIN=$FULL_DOMAIN" >> $GITHUB_ENV

          curl -X POST "${{ env.CALLBACK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "company_code": "${{ env.COMPANY_CODE }}",
              "status": "started",
              "step": "infrastructure",
              "progress_percentage": 60,
              "message": "DNS record created for '"$FULL_DOMAIN"'",
              "logs": "Cloudflare DNS A record created successfully at $(date) - Domain: '"$FULL_DOMAIN"'"
            }' || echo "Callback failed - continuing..."

      # ‚úÖ UPDATED: Use dynamic variables and add progress percentage
      - name: üîß Notify Server Setup Phase
        run: |
          curl -X POST "${{ env.CALLBACK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "company_code": "${{ env.COMPANY_CODE }}",
              "status": "started",
              "step": "server",
              "progress_percentage": 70,
              "message": "Configuring server and creating site directory",
              "logs": "Server setup started at $(date) - creating site user and directories"
            }' || echo "Callback failed - continuing..."

      - name: Add site via clpctl
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          password: ${{ secrets.VPS_PASS }}
          script: |
            DOMAIN_NAME="${{ env.SUBDOMAIN }}"
            SITE_USER=$(echo "${{ env.USERNAME }}" | tr -cd '[:alnum:]-')-timoraph
            echo "Creating site for domain: $DOMAIN_NAME with user: $SITE_USER"
            clpctl site:add:php --domainName="$DOMAIN_NAME" --phpVersion=8.2 --vhostTemplate='Laravel 11' --siteUser="$SITE_USER" --siteUserPassword='SecurePassword'
            echo "Site creation completed successfully"

      - name: Notify server setup completed
        run: |
          curl -X POST "${{ env.CALLBACK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "company_code": "${{ env.COMPANY_CODE }}",
              "status": "started",
              "step": "server",
              "progress_percentage": 75,
              "message": "Server site configuration completed",
              "logs": "ClpCtl site creation completed successfully at $(date) - User: ${{ env.USERNAME }}"
            }' || echo "Callback failed - continuing..."

      # ‚úÖ UPDATED: Use dynamic variables and add progress percentage
      - name: üìÅ Notify Deployment Phase
        run: |
          curl -X POST "${{ env.CALLBACK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "company_code": "${{ env.COMPANY_CODE }}",
              "status": "started",
              "step": "deployment",
              "progress_percentage": 85,
              "message": "Deploying application files and configuring database",
              "logs": "File deployment started at $(date) - copying application files to server"
            }' || echo "Callback failed - continuing..."

      - name: Copy files via SCP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          password: ${{ secrets.VPS_PASS }}
          source: "."
          target: "/tmp/deploy-${{ env.SUBDOMAIN }}"

      - name: Move files to correct location with sanitized username
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          password: ${{ secrets.VPS_PASS }}
          script: |
            SITE_USER=$(echo "${{ env.USERNAME }}" | tr -cd '[:alnum:]-')-timoraph
            TARGET_DIR="/home/$SITE_USER/htdocs/${{ env.SUBDOMAIN }}"
            mkdir -p "$TARGET_DIR"
            rsync -av /tmp/deploy-${{ env.SUBDOMAIN }}/ "$TARGET_DIR/"
            rm -rf /tmp/deploy-${{ env.SUBDOMAIN }}
            echo "Files moved to $TARGET_DIR successfully"

      - name: Notify file deployment completed
        run: |
          curl -X POST "${{ env.CALLBACK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "company_code": "${{ env.COMPANY_CODE }}",
              "status": "started",
              "step": "deployment",
              "progress_percentage": 90,
              "message": "Application files deployed successfully",
              "logs": "SCP file transfer completed at $(date) - All application files copied to server"
            }' || echo "Callback failed - continuing..."

      # ‚úÖ UPDATED: Use dynamic variables and add progress percentage
      - name: üîß Notify Final Configuration
        run: |
          curl -X POST "${{ env.CALLBACK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "company_code": "${{ env.COMPANY_CODE }}",
              "status": "started",
              "step": "finalization",
              "progress_percentage": 95,
              "message": "Finalizing configuration and starting services",
              "logs": "Final configuration started at $(date) - setting up database, cron jobs, and workers"
            }' || echo "Callback failed - continuing..."

      - name: Run post-deploy commands via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          password: ${{ secrets.VPS_PASS }}
          envs: PASSWORD,EMAIL,USERNAME,COMPANY_NAME,COMPANY_CODE,PLAN,BILLING_CYCLE,AMOUNT
          script: |
            SITE_USER=$(echo "${{ env.USERNAME }}" | tr -cd '[:alnum:]-')-timoraph
            DB_NAME=$(echo "${{ env.COMPANY_NAME }}" | tr '[:upper:]' '[:lower:]' | tr -d ' ._' | tr -cd '[:alnum:]')db
            DB_USER=$(echo "${{ env.USERNAME }}" | tr -d ' ._' | tr -cd '[:alnum:]')dev
            DB_PASS=JAF2025

            # Create database and user using clpctl
            clpctl db:add --domainName="${{ env.SUBDOMAIN }}" --databaseName="$DB_NAME" --databaseUserName="$DB_USER" --databaseUserPassword="$DB_PASS"

            cd "/home/$SITE_USER/htdocs/${{ env.SUBDOMAIN }}"
            cp .env.testing .env
            composer install --no-dev

            # Update .env with new DB credentials before running artisan commands
            ENV_PATH="/home/$SITE_USER/htdocs/${{ env.SUBDOMAIN }}/.env"
            sed -i "s/^DB_DATABASE=.*/DB_DATABASE=$DB_NAME/" "$ENV_PATH"
            sed -i "s/^DB_USERNAME=.*/DB_USERNAME=root/" "$ENV_PATH"
            sed -i "s/^DB_PASSWORD=.*/DB_PASSWORD=${{ secrets.MYSQL_ROOT_PASSWORD }}/" "$ENV_PATH"

            # Update APP_URL with dynamic subdomain (all lowercase)
            SUBDOMAIN_LOWER=$(echo "${{ env.DOMAIN_NAME }}" | tr '[:upper:]' '[:lower:]')
            APP_URL="https://${SUBDOMAIN_LOWER}.timora.ph"
            sed -i "s|^APP_URL=.*|APP_URL=$APP_URL|" "$ENV_PATH"

            # Update HitPay credentials
            sed -i "s|^HITPAY_API_KEY=.*|HITPAY_API_KEY=${{ secrets.HITPAY_API_KEY }}|" "$ENV_PATH"
            sed -i "s|^HITPAY_SALT=.*|HITPAY_SALT=${{ secrets.HITPAY_SALT }}|" "$ENV_PATH"
            sed -i "s|^HITPAY_BASE_URL=.*|HITPAY_BASE_URL=${{ secrets.HITPAY_BASE_URL }}|" "$ENV_PATH"
            sed -i "s|^HITPAY_WEBHOOK_URL=.*|HITPAY_WEBHOOK_URL=${APP_URL}/hitpay/webhook|" "$ENV_PATH"

            # add worker config
            WORKER_CONF="/etc/supervisor/conf.d/$SITE_USER-timora-worker.conf"
            cat <<EOF | sudo tee "$WORKER_CONF"
            [program:$SITE_USER-timora-worker]
            process_name=%(program_name)s_%(process_num)02d
            command=php /home/$SITE_USER/htdocs/${{ env.SUBDOMAIN }}/artisan queue:work --sleep=3 --tries=3 --timeout=90
            autostart=true
            autorestart=true
            user=root
            numprocs=1
            redirect_stderr=true
            stdout_logfile=/home/$SITE_USER/htdocs/${{ env.SUBDOMAIN }}/storage/logs/supervisor_worker.log
            stderr_logfile=/home/$SITE_USER/htdocs/${{ env.SUBDOMAIN }}/storage/logs/supervisor_worker_error.log
            stopwaitsecs=3600
            EOF

            # add email queue worker config
            EMAIL_WORKER_CONF="/etc/supervisor/conf.d/$SITE_USER-timora-email-worker.conf"
            cat <<EOF | sudo tee "$EMAIL_WORKER_CONF"
            [program:$SITE_USER-timora-email-worker]
            process_name=%(program_name)s_%(process_num)02d
            command=php /home/$SITE_USER/htdocs/${{ env.SUBDOMAIN }}/artisan queue:work --queue=emails --sleep=3 --tries=3 --timeout=90
            autostart=true
            autorestart=true
            user=root
            numprocs=1
            redirect_stderr=true
            stdout_logfile=/home/$SITE_USER/htdocs/${{ env.SUBDOMAIN }}/storage/logs/email_worker.log
            stderr_logfile=/home/$SITE_USER/htdocs/${{ env.SUBDOMAIN }}/storage/logs/email_worker_error.log
            stopwaitsecs=3600
            EOF

            ( crontab -l 2>/dev/null; echo "* * * * * /usr/bin/php8.2 /home/$SITE_USER/htdocs/${{ env.SUBDOMAIN }}/artisan schedule:run >> /dev/null 2>&1" ) | crontab -

            sudo supervisorctl reread
            sudo supervisorctl update
            sudo supervisorctl restart "$SITE_USER-timora-worker"

            # Update env variables for database
            SEEDER_PATH="database/seeders/GlobalUserTableSeeder.php"
            sed -i "s/^DB_DATABASE=.*/DB_DATABASE=$DB_NAME/" "$ENV_PATH"
            sed -i "s/^DB_USERNAME=.*/DB_USERNAME=$DB_USER/" "$ENV_PATH"
            sed -i "s/^DB_PASSWORD=.*/DB_PASSWORD=$DB_PASS/" "$ENV_PATH"

            # Update GlobalUserTableSeeder.php with dynamic email, username, and plain password for Hash::make
            SEEDER_PATH="database/seeders/GlobalUserTableSeeder.php"
            COMPANY_ADMIN="${{ env.USERNAME }}"
            EMAIL="${{ env.EMAIL }}"
            PLAIN_PASSWORD="$PASSWORD"
            echo "Password length inside SSH: ${#PASSWORD}"
            sed -i "0,/'username' => '[^']*'/s//'username' => '$COMPANY_ADMIN'/" "$SEEDER_PATH"
            sed -i "0,/'email' => '[^']*'/s//'email' => '$EMAIL'/" "$SEEDER_PATH"
            sed -i "0,/Hash::make([^)]*)/s//Hash::make('$PLAIN_PASSWORD')/" "$SEEDER_PATH"



            # Update TenantTableSeeder.php with dynamic tenant_name and tenant_code
            TENANT_SEEDER_PATH="database/seeders/TenantTableSeeder.php"
            COMPANY_NAME="${{ env.COMPANY_NAME }}"
            COMPANY_CODE_UPPER=$(echo "${{ env.COMPANY_CODE }}" | tr '[:lower:]' '[:upper:]')
            sed -i "s/'tenant_name' => '[^']*'/'tenant_name' => '$COMPANY_NAME'/" "$TENANT_SEEDER_PATH"
            sed -i "s/'tenant_code' => '[^']*'/'tenant_code' => '$COMPANY_CODE_UPPER'/" "$TENANT_SEEDER_PATH"

            # Update SubscriptionsTableSeeder.php with dynamic plan details
            SELECTED_PLAN="${{ env.PLAN }}"
            BILLING_CYCLE="${{ env.BILLING_CYCLE }}"
            AMOUNT="${{ env.AMOUNT }}"

            # Get the plan ID by querying the database after seeding
            SUBS_SEEDER_PATH="database/seeders/SubscriptionsTableSeeder.php"

            # Calculate the plan ID based on the pattern:
            # Free=1, Starter monthly=2, Core monthly=3, Pro monthly=4, Elite monthly=5
            # Starter yearly=6, Core yearly=7, Pro yearly=8, Elite yearly=9
            if [ "$SELECTED_PLAN" = "free" ]; then
              PLAN_ID=1
            elif [ "$SELECTED_PLAN" = "starter" ] && [ "$BILLING_CYCLE" = "monthly" ]; then
              PLAN_ID=2
            elif [ "$SELECTED_PLAN" = "core" ] && [ "$BILLING_CYCLE" = "monthly" ]; then
              PLAN_ID=3
            elif [ "$SELECTED_PLAN" = "pro" ] && [ "$BILLING_CYCLE" = "monthly" ]; then
              PLAN_ID=4
            elif [ "$SELECTED_PLAN" = "elite" ] && [ "$BILLING_CYCLE" = "monthly" ]; then
              PLAN_ID=5
            elif [ "$SELECTED_PLAN" = "starter" ] && [ "$BILLING_CYCLE" = "yearly" ]; then
              PLAN_ID=6
            elif [ "$SELECTED_PLAN" = "core" ] && [ "$BILLING_CYCLE" = "yearly" ]; then
              PLAN_ID=7
            elif [ "$SELECTED_PLAN" = "pro" ] && [ "$BILLING_CYCLE" = "yearly" ]; then
              PLAN_ID=8
            elif [ "$SELECTED_PLAN" = "elite" ] && [ "$BILLING_CYCLE" = "yearly" ]; then
              PLAN_ID=9
            else
              PLAN_ID=2 # default Starter monthly
            fi

            # Update SubscriptionsTableSeeder with the matching plan_id
            sed -i "s/'plan_id' => [0-9]\+/'plan_id' => $PLAN_ID/" "$SUBS_SEEDER_PATH"
            sed -i "s/'billing_cycle' => 'monthly'/'billing_cycle' => '$BILLING_CYCLE'/" "$SUBS_SEEDER_PATH"
            sed -i "s/'amount_paid' => [0-9.]\+/'amount_paid' => $AMOUNT/" "$SUBS_SEEDER_PATH"

            # Extract plan-specific values from PlanSeeder.php so subscription seeder
            # will reflect the selected plan's defaults (base licenses, implementation_fee)
            PLAN_SEEDER="database/seeders/PlanSeeder.php"

            # Get the Nth occurrence of base_license_count and implementation_fee from PlanSeeder
            BASE_LICENSE=$(grep -n "'base_license_count'" "$PLAN_SEEDER" | sed -n "${PLAN_ID}p" | sed -E "s/.*'base_license_count' => ([0-9]+).*/\1/")
            IMPLEMENTATION_FEE=$(grep -n "'implementation_fee'" "$PLAN_SEEDER" | sed -n "${PLAN_ID}p" | sed -E "s/.*'implementation_fee' => ([0-9.]+).*/\1/")

            # Fallback defaults if grep fails
            BASE_LICENSE=${BASE_LICENSE:-1}
            IMPLEMENTATION_FEE=${IMPLEMENTATION_FEE:-0}

            # Replace values in SubscriptionsTableSeeder.php so the seeded subscription uses
            # the selected plan's base license count and implementation fee
            sed -i "s/'active_license' => [0-9]\+/'active_license' => $BASE_LICENSE/" "$SUBS_SEEDER_PATH"
            sed -i "s/'implementation_fee' => [0-9.]\\+/'implementation_fee' => $IMPLEMENTATION_FEE/" "$SUBS_SEEDER_PATH"

            # Keep implementation_fee_paid as 0 by default and set subscription dates/status
            sed -i "s/'implementation_fee_paid' => [0-9.]\\+/'implementation_fee_paid' => 0/" "$SUBS_SEEDER_PATH"

            # Compute dynamic dates based on billing cycle:
            # - monthly: next renewal = today + 1 month
            # - yearly: next renewal = today + 1 year
            if [ "$BILLING_CYCLE" = "monthly" ]; then
              NEXT_RENEWAL_DATE=$(date -d "+1 month" '+%Y-%m-%d')
            else
              NEXT_RENEWAL_DATE=$(date -d "+1 year" '+%Y-%m-%d')
            fi

            # subscription_end is the day before next_renewal_date
            SUBS_END=$(date -d "$NEXT_RENEWAL_DATE -1 day" '+%Y-%m-%d')

            sed -i "s/'subscription_end' => '[^']*'/'subscription_end' => '$SUBS_END'/'" "$SUBS_SEEDER_PATH"
            sed -i "s/'next_renewal_date' => '[^']*'/'next_renewal_date' => '$NEXT_RENEWAL_DATE'/'" "$SUBS_SEEDER_PATH"
            sed -i "s/'status' => '[^']*'/'status' => 'active'/'" "$SUBS_SEEDER_PATH"

            # Update InvoicesTableSeeder.php to align with subscription seeder
            # The invoice seeder will automatically read from the subscription, but we ensure
            # the billing cycle variable matches what will be seeded
            INVOICE_SEEDER_PATH="database/seeders/InvoicesTableSeeder.php"
            sed -i "s/\$billingCycle = 'monthly';/\$billingCycle = '$BILLING_CYCLE';/" "$INVOICE_SEEDER_PATH"

            # Configure Laravel environment first
            php artisan key:generate
            php artisan config:clear
            php artisan config:cache
            php artisan route:cache

            # ‚ú® INJECT WIZARD SUBSCRIPTION DATA FOR ACCURATE INVOICING ‚ú®
            echo "üöÄ Injecting wizard subscription data for accurate invoicing..."

            # Debug: Verify environment variables exist
            echo "üîç Checking wizard payload environment variables..."
            echo "SUBSCRIPTION_DETAILS length: ${#SUBSCRIPTION_DETAILS}"
            echo "PRICING_BREAKDOWN length: ${#PRICING_BREAKDOWN}"  
            echo "SELECTED_DEVICES length: ${#SELECTED_DEVICES}"

            # Use the complete wizard data from the payload instead of minimal data
            # Use jq to properly construct JSON with actual payload data
            WIZARD_JSON=$(jq -n \
              --arg ref_num "${REFERENCE_NUMBER:-}" \
              --argjson sub_details "${SUBSCRIPTION_DETAILS:-{}}" \
              --argjson pricing "${PRICING_BREAKDOWN:-{}}" \
              --argjson devices "${SELECTED_DEVICES:-[]}" \
              --argjson services "${SELECTED_BIOMETRIC_SERVICES:-{}}" \
              --argjson company "${COMPANY_DETAILS:-{}}" \
              --argjson user "${USER_DETAILS:-{}}" \
              '{
                reference_number: $ref_num,
                subscription_details: $sub_details,
                pricing_breakdown: $pricing,
                selected_devices: $devices,
                selected_biometric_services: $services,
                company_details: $company,
                user_details: $user
              }')

            # Debug: Show preview of reconstructed JSON  
            echo "üìã Wizard JSON preview (first 300 chars): ${WIZARD_JSON:0:300}"

            # Set wizard data environment variable directly  
            echo "WIZARD_SUBSCRIPTION_DATA='$WIZARD_JSON'" >> .env
            echo "üìù Wizard data environment variable set"

            # Inject wizard data using the script if available
            if [ -f "scripts/inject-wizard-data.php" ]; then
              echo "Calling wizard data injection script..."
              php scripts/inject-wizard-data.php "$WIZARD_JSON" || echo "‚ö†Ô∏è Wizard data injection failed - will use legacy seeding"
            else
              echo "‚ö†Ô∏è Wizard data injection script not found - using legacy invoice seeding"
            fi

            # Fresh migrate and seed the database
            php artisan migrate:fresh --seed --force
            php artisan storage:link
            chmod -R guo+w storage

            git config --global --add safe.directory "/home/$SITE_USER/htdocs/${{ env.SUBDOMAIN }}"

            sudo chown -R $SITE_USER:$SITE_USER /home/$SITE_USER/htdocs/${{ env.SUBDOMAIN}}

      - name: Assigning Custom Domains
        run: |
          echo ""
          echo "üîó Visit your app: https://${{ env.SUBDOMAIN }}"
          echo ""

      - name: Add deployed URL and build logs to workflow summary
        run: |
          echo "### ‚úÖ App Deployed Successfully" >> $GITHUB_STEP_SUMMARY
          echo "üîó [https://${{ env.SUBDOMAIN }}](https://${{ env.SUBDOMAIN }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      # ‚úÖ Send Account Credentials Email After Successful Deployment
      - name: üìß Send Account Credentials Email
        if: success()
        run: |
          curl -X POST "https://api-wizard.timora.ph/api/wizard/send-payment-email" \
            -H "Content-Type: application/json" \
            -H "Accept: application/json" \
            -d '{
              "email": "${{ env.EMAIL }}",
              "company_name": "${{ env.COMPANY_NAME }}",
              "company_code": "${{ env.COMPANY_CODE }}",
              "subdomain": "${{ env.SUBDOMAIN }}",
              "system": "${{ env.SYSTEM }}",
              "plan": "${{ env.PLAN }}",
              "username": "${{ env.USERNAME }}",
              "password": "${{ env.PASSWORD }}"
            }' || echo "Credentials email failed - continuing..."

      # ‚úÖ UPDATED: Use dynamic variables and add progress percentage
      - name: ‚úÖ Notify Success
        if: success()
        run: |
          curl -X POST "${{ env.CALLBACK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "company_code": "${{ env.COMPANY_CODE }}",
              "status": "success",
              "step": "completed",
              "progress_percentage": 100,
              "message": "Deployment completed successfully! Portal is live at https://${{ env.SUBDOMAIN }}",
              "logs": "üéâ Timora portal is now live at https://${{ env.SUBDOMAIN }}\n\n‚úÖ All services running\n‚úÖ SSL certificate active\n‚úÖ Database connected\n‚úÖ Ready for users!"
            }' || echo "Success callback failed"

      # ‚úÖ UPDATED: Use dynamic variables
      - name: ‚ùå Notify Failure
        if: failure()
        run: |
          curl -X POST "${{ env.CALLBACK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "company_code": "${{ env.COMPANY_CODE }}",
              "status": "failed",
              "step": "error",
              "message": "Deployment failed during GitHub Actions execution. Please check logs and try again.",
              "logs": "GitHub Actions workflow failed at $(date) - check run details for specific error. Last step attempted: ${{ github.action }}",
              "error_details": {
                "workflow_run_id": "${{ github.run_id }}",
                "failed_step": "${{ github.action }}",
                "repository": "${{ github.repository }}",
                "timestamp": "${{ github.event.head_commit.timestamp }}"
              }
            }' || echo "Failure callback failed"
