name: Cloud Panel Deployment Workflow V2

on:
  workflow_dispatch:
    inputs:
      system:
        description: "System type"
        required: true
        type: string
      plan:
        description: "Plan type"
        required: true
        type: string
      email:
        description: "User email"
        required: true
        type: string
      company_name:
        description: "Company name"
        required: true
        type: string
      domain_name:
        description: "Domain name"
        required: true
        type: string
      company_code:
        description: "Company code"
        required: true
        type: string
      username:
        description: "User name"
        required: true
        type: string
      password:
        description: "User password"
        required: true
        type: string
      billing_cycle:
        description: "Billing cycle (monthly/yearly)"
        required: true
        type: string
      amount:
        description: "Amount paid"
        required: true
        type: string

jobs:
  laravel-tests:
    name: Build Logs
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: laravel
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h localhost"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.2"
          extensions: mbstring, bcmath, mysql
          coverage: none

      - name: Install Composer dependencies
        run: composer install --prefer-dist --no-progress --no-suggest

      - name: Set up environment
        run: |
          echo "${{ secrets.ENV }}" > .env
          php artisan key:generate

      - name: Wait for MySQL to be ready
        run: sleep 15

      - name: Run migrations
        env:
          DB_CONNECTION: mysql
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_DATABASE: laravel
          DB_USERNAME: root
          DB_PASSWORD: root
        run: php artisan migrate --force

  deploy:
    name: Deployment Summary
    needs: laravel-tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Create DNS record via Cloudflare API
        run: |
          SUBDOMAIN=$(echo "${{ github.event.inputs.domain_name }}" | tr '[:upper:]' '[:lower:]' | tr -d ' ')
          ROOT_DOMAIN=timora.ph
          FULL_DOMAIN="$SUBDOMAIN.$ROOT_DOMAIN"

          curl -X POST "https://api.cloudflare.com/client/v4/zones/${{ secrets.CLOUDFLARE_ZONE_ID }}/dns_records" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            --data '{
              "type": "A",
              "name": "'"$FULL_DOMAIN"'",
              "content": "'"${{ secrets.VPS_PUBLIC_IP }}"'",
              "ttl": 120,
              "proxied": true
            }'

          echo "âœ… DNS record created: $FULL_DOMAIN"
          echo "SUBDOMAIN=$FULL_DOMAIN" >> $GITHUB_ENV

      - name: Add site via clpctl
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          password: ${{ secrets.VPS_PASS }}
          script: |
            DOMAIN_NAME="${{ env.SUBDOMAIN }}"
            SITE_USER="${{ github.event.inputs.username }}"
            clpctl site:add:php --domainName="$DOMAIN_NAME" --phpVersion=8.2 --vhostTemplate='Laravel 11' --siteUser="$SITE_USER" --siteUserPassword='SecurePassword'

      - name: Copy files via SCP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          password: ${{ secrets.VPS_PASS }}
          source: "."
          target: "/home/${{ github.event.inputs.username }}/htdocs/${{ env.SUBDOMAIN }}"

      - name: Run post-deploy commands via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          password: ${{ secrets.VPS_PASS }}
          script: |
            DB_NAME=$(echo "${{ github.event.inputs.company_name }}" | tr '[:upper:]' '[:lower:]' | tr -d ' ._' | tr -cd '[:alnum:]')db
            DB_USER=$(echo "${{ github.event.inputs.username }}" | tr -d ' ._' | tr -cd '[:alnum:]')dev
            DB_PASS=JAF2025

            # Create database and user using clpctl
            clpctl db:add --domainName="${{ env.SUBDOMAIN }}" --databaseName="$DB_NAME" --databaseUserName="$DB_USER" --databaseUserPassword="$DB_PASS"

            cd "/home/${{ github.event.inputs.username }}/htdocs/${{ env.SUBDOMAIN }}"
            cp .env.testing .env
            composer install --no-dev

            # Update .env with new DB credentials before running artisan commands
            ENV_PATH="/home/${{ github.event.inputs.username }}/htdocs/${{ env.SUBDOMAIN }}/.env"
            sed -i "s/^DB_DATABASE=.*/DB_DATABASE=$DB_NAME/" "$ENV_PATH"
            sed -i "s/^DB_USERNAME=.*/DB_USERNAME=root/" "$ENV_PATH"
            sed -i "s/^DB_PASSWORD=.*/DB_PASSWORD=${{ secrets.MYSQL_ROOT_PASSWORD }}/" "$ENV_PATH"

            # Update APP_URL with dynamic subdomain (all lowercase)
            SUBDOMAIN_LOWER=$(echo "${{ github.event.inputs.domain_name }}" | tr '[:upper:]' '[:lower:]')
            APP_URL="https://${SUBDOMAIN_LOWER}.timora.ph"
            sed -i "s|^APP_URL=.*|APP_URL=$APP_URL|" "$ENV_PATH"      

            # add worker config
            WORKER_CONF="/etc/supervisor/conf.d/${{ github.event.inputs.username }}-timora-worker.conf"
            cat <<EOF | sudo tee "$WORKER_CONF"
            [program:${{ github.event.inputs.username }}-timora-worker]
            process_name=%(program_name)s_%(process_num)02d
            command=php /home/${{ github.event.inputs.username }}/htdocs/${{ env.SUBDOMAIN }}/artisan queue:work --sleep=3 --tries=3 --timeout=90
            autostart=true
            autorestart=true
            user=root
            numprocs=1
            redirect_stderr=true
            stdout_logfile=/home/${{ github.event.inputs.username }}/htdocs/${{ env.SUBDOMAIN }}/storage/logs/supervisor_worker.log
            stderr_logfile=/home/${{ github.event.inputs.username }}/htdocs/${{ env.SUBDOMAIN }}/storage/logs/supervisor_worker_error.log
            stopwaitsecs=3600
            EOF

            # add email queue worker config
            EMAIL_WORKER_CONF="/etc/supervisor/conf.d/${{ github.event.inputs.username }}-timora-email-worker.conf"
            cat <<EOF | sudo tee "$EMAIL_WORKER_CONF"
            [program:${{ github.event.inputs.username }}-timora-email-worker]
            process_name=%(program_name)s_%(process_num)02d
            command=php /home/${{ github.event.inputs.username }}/htdocs/${{ env.SUBDOMAIN }}/artisan queue:work --queue=emails --sleep=3 --tries=3 --timeout=90
            autostart=true
            autorestart=true
            user=root
            numprocs=1
            redirect_stderr=true
            stdout_logfile=/home/${{ github.event.inputs.username }}/htdocs/${{ env.SUBDOMAIN }}/storage/logs/email_worker.log
            stderr_logfile=/home/${{ github.event.inputs.username }}/htdocs/${{ env.SUBDOMAIN }}/storage/logs/email_worker_error.log
            stopwaitsecs=3600
            EOF

            ( crontab -l 2>/dev/null; echo "* * * * * /usr/bin/php8.2 /home/${{ github.event.inputs.username }}/htdocs/${{ env.SUBDOMAIN }}/artisan schedule:run >> /dev/null 2>&1" ) | crontab -

            sudo supervisorctl reread
            sudo supervisorctl update
            sudo supervisorctl restart "${{ github.event.inputs.user_name }}-timora-worker"

            # Update env variables for database 
            SEEDER_PATH="database/seeders/GlobalUserTableSeeder.php"
            sed -i "s/^DB_DATABASE=.*/DB_DATABASE=$DB_NAME/" "$ENV_PATH"
            sed -i "s/^DB_USERNAME=.*/DB_USERNAME=$DB_USER/" "$ENV_PATH"
            sed -i "s/^DB_PASSWORD=.*/DB_PASSWORD=$DB_PASS/" "$ENV_PATH"

            # Update GlobalUserTableSeeder.php with dynamic email, username, and plain password for Hash::make
            SEEDER_PATH="database/seeders/GlobalUserTableSeeder.php"
            COMPANY_ADMIN="${{ github.event.inputs.username }}"
            EMAIL="${{ github.event.inputs.email }}"
            PLAIN_PASSWORD="${{ github.event.inputs.password }}"
            sed -i "0,/'username' => '[^']*'/s//'username' => '$COMPANY_ADMIN'/" "$SEEDER_PATH"
            sed -i "0,/'email' => '[^']*'/s//'email' => '$EMAIL'/" "$SEEDER_PATH"
            sed -i "0,/Hash::make([^)]*)/s//Hash::make('$PLAIN_PASSWORD')/" "$SEEDER_PATH"

            # Update TenantTableSeeder.php with dynamic tenant_name and tenant_code
            TENANT_SEEDER_PATH="database/seeders/TenantTableSeeder.php"
            COMPANY_NAME="${{ github.event.inputs.company_name }}"
            COMPANY_CODE_UPPER=$(echo "${{ github.event.inputs.company_code }}" | tr '[:lower:]' '[:upper:]')
            sed -i "s/'tenant_name' => '[^']*'/'tenant_name' => '$COMPANY_NAME'/" "$TENANT_SEEDER_PATH"
            sed -i "s/'tenant_code' => '[^']*'/'tenant_code' => '$COMPANY_CODE_UPPER'/" "$TENANT_SEEDER_PATH"

            # Update SubscriptionsTableSeeder.php with dynamic plan details
            SELECTED_PLAN="${{ github.event.inputs.plan }}"
            BILLING_CYCLE="${{ github.event.inputs.billing_cycle }}"
            AMOUNT="${{ github.event.inputs.amount }}"

            # Get the plan ID by querying the database after seeding
            SUBS_SEEDER_PATH="database/seeders/SubscriptionsTableSeeder.php"
            
            # For now, we'll calculate the plan ID based on the pattern:
            # Starter monthly=1, Core monthly=2, Pro monthly=3, Elite monthly=4
            # Starter yearly=5, Core yearly=6, Pro yearly=7, Elite yearly=8
            if [ "$SELECTED_PLAN" = "starter" ] && [ "$BILLING_CYCLE" = "monthly" ]; then
              PLAN_ID=1
            elif [ "$SELECTED_PLAN" = "core" ] && [ "$BILLING_CYCLE" = "monthly" ]; then
              PLAN_ID=2
            elif [ "$SELECTED_PLAN" = "pro" ] && [ "$BILLING_CYCLE" = "monthly" ]; then
              PLAN_ID=3
            elif [ "$SELECTED_PLAN" = "elite" ] && [ "$BILLING_CYCLE" = "monthly" ]; then
              PLAN_ID=4
            elif [ "$SELECTED_PLAN" = "starter" ] && [ "$BILLING_CYCLE" = "yearly" ]; then
              PLAN_ID=5
            elif [ "$SELECTED_PLAN" = "core" ] && [ "$BILLING_CYCLE" = "yearly" ]; then
              PLAN_ID=6
            elif [ "$SELECTED_PLAN" = "pro" ] && [ "$BILLING_CYCLE" = "yearly" ]; then
              PLAN_ID=7
            elif [ "$SELECTED_PLAN" = "elite" ] && [ "$BILLING_CYCLE" = "yearly" ]; then
              PLAN_ID=8
            else
              PLAN_ID=1 # default Starter monthly
            fi

            # Update SubscriptionsTableSeeder with the matching plan_id
            sed -i "s/'plan_id' => [0-9]\+/'plan_id' => $PLAN_ID/" "$SUBS_SEEDER_PATH"
            sed -i "s/'billing_cycle' => 'monthly'/'billing_cycle' => '$BILLING_CYCLE'/" "$SUBS_SEEDER_PATH"
            sed -i "s/'amount_paid' => [0-9.]\+/'amount_paid' => $AMOUNT/" "$SUBS_SEEDER_PATH"

            # Extract plan-specific values from PlanSeeder.php so subscription seeder
            # will reflect the selected plan's defaults (base licenses, implementation_fee)
            PLAN_SEEDER="database/seeders/PlanSeeder.php"

            # Get the Nth occurrence of base_license_count and implementation_fee from PlanSeeder
            BASE_LICENSE=$(grep -n "'base_license_count'" "$PLAN_SEEDER" | sed -n "${PLAN_ID}p" | sed -E "s/.*'base_license_count' => ([0-9]+).*/\1/")
            IMPLEMENTATION_FEE=$(grep -n "'implementation_fee'" "$PLAN_SEEDER" | sed -n "${PLAN_ID}p" | sed -E "s/.*'implementation_fee' => ([0-9.]+).*/\1/")

            # Fallback defaults if grep fails
            BASE_LICENSE=${BASE_LICENSE:-1}
            IMPLEMENTATION_FEE=${IMPLEMENTATION_FEE:-0}

            # Replace values in SubscriptionsTableSeeder.php so the seeded subscription uses
            # the selected plan's base license count and implementation fee
            sed -i "s/'active_license' => [0-9]\+/'active_license' => $BASE_LICENSE/" "$SUBS_SEEDER_PATH"
            sed -i "s/'implementation_fee' => [0-9.]\\+/'implementation_fee' => $IMPLEMENTATION_FEE/" "$SUBS_SEEDER_PATH"

            # Keep implementation_fee_paid as 0 by default and set subscription dates/status
            sed -i "s/'implementation_fee_paid' => [0-9.]\\+/'implementation_fee_paid' => 0/" "$SUBS_SEEDER_PATH"

            # Compute dynamic dates based on billing cycle:
            # - monthly: next renewal = today + 1 month
            # - yearly: next renewal = today + 1 year
            if [ "$BILLING_CYCLE" = "monthly" ]; then
              NEXT_RENEWAL_DATE=$(date -d "+1 month" '+%Y-%m-%d')
            else
              NEXT_RENEWAL_DATE=$(date -d "+1 year" '+%Y-%m-%d')
            fi

            # subscription_end is the day before next_renewal_date
            SUBS_END=$(date -d "$NEXT_RENEWAL_DATE -1 day" '+%Y-%m-%d')

            sed -i "s/'subscription_end' => '[^']*'/'subscription_end' => '$SUBS_END'/'" "$SUBS_SEEDER_PATH"
            sed -i "s/'next_renewal_date' => '[^']*'/'next_renewal_date' => '$NEXT_RENEWAL_DATE'/'" "$SUBS_SEEDER_PATH"
            sed -i "s/'status' => '[^']*'/'status' => 'active'/'" "$SUBS_SEEDER_PATH"


            # Fresh migrate and seed the database
            php artisan key:generate
            php artisan config:clear
            php artisan config:cache
            php artisan route:cache
            php artisan migrate:fresh --seed --force
            php artisan storage:link
            chmod -R guo+w storage


            git config --global --add safe.directory "/home/${{ github.event.inputs.username }}/htdocs/${{ env.SUBDOMAIN }}"

            sudo chown -R ${{ github.event.inputs.username }}:${{ github.event.inputs.username }} /home/${{ github.event.inputs.username }}/htdocs/${{ env.SUBDOMAIN}}

      - name: Assigning Custom Domains
        run: |
          echo ""
          echo "ðŸ”— Visit your app: https://${{ env.SUBDOMAIN }}"
          echo ""


      - name: Add deployed URL and build logs to workflow summary
        run: |
          echo "### âœ… App Deployed Successfully" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— [https://${{ env.SUBDOMAIN }}](https://${{ env.SUBDOMAIN }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

